---
layout: post
author: fcerbell
title: Connexion JDBC depuis JasperReports Server à Couchbase
categories: [Tutoriel, Tutorial]
date:   2015-08-26 19:15:06
tags: [couchbase, jaspersoft, reporting, jdbc, n1ql]
featimg: cb.svg
---

[Couchbase], une base BigData NoSQL, propose désormais un nouveau langage, N1QL, pour effectuer des requêtes. L'idée de cet article est de montrer comment utiliser le nouveau pilote JDBC de [Couchbase] dans [JasperReports Server][jrs], de manière à exécuter des requêtes SQL sur la base [Couchbase].

Pré-requis
==========
Comme pour tout tutoriel, il y a des pré-requis nécessaires. Voici ceux concernant celui-ci.

Couchbase Server
----------------
En premier lieu, il faut bien évidemment disposer d'un cluster [Couchbase] au minimum en version 4.0. À l'heure où j'écris ces lignes, il est disponible en [version beta][cb40beta] sur le site de [Couchbase]. Ce cluster doit comporter au moins un nœud avec le service *Index* et au moins un nœud avec le service *Query*.


JasperReports Server
--------------------
En second, il faut disposer d'un serveur [JasperReports][jrs] fonctionnel.

Pilote JDBC Couchbase 
---------------------
Enfin, il faut disposer du pilote JDBC fourni par [Couchbase].

Ajouter le pilote JDBC dans le classpath
========================================

Par défaut, JRS(JasperReports Server) ne fournit pas le pilote JDBC pour Couchbase. Il faut donc ajouter le pilote dans le classpath de la JVM
exécutant JRS. Ayant installé JRS avec l'installeur d'évaluation, Apache Tomcat a été installé et configuré
pour exécuter JRS. Il se trouve dans le sous répertoire apache-tomcat du répertoire d'installation. L'application JasperReports
Server se trouve dans le sous-répertoire apache-tomcat/webapps/jasperserver-pro. Il est donc possible d'ajouter le pilote au niveau du serveur
de conteneur JAVA (Tomcat) ou au niveau de l'application. J'ai fait le choix de l'installer au niveau du serveur de conteneur, dans le
sous-répertoire apache-tomcat/lib .

Il faut donc copier tous les fichiers du pilote JDBC (sauf éventuellement le fichier PDF), dans le sous-répertoire des bibliothèques partagées
de Tomcat :

```
cp SimbaCouchbaseJDBC41_Beta_Update3/*.{jar,lic} /opt/jasperreports-server-6.1.0/apache-tomcat/lib/
```

Une fois les pilotes installés, il faut redémarrer Tomcat :
```
cd jasperreports-server-6.1.0
./ctlscript.sh restart
```

Le pilote est désormais disponible dans JRS.

Créer la datasource dans JRS
============================

Nous allons commencer par créer une structure de répertoires pour ranger les différents éléments du tutoriel proprement en suivant les bonnes
pratiques. Nous créerons ensuite une source de données se connectant à Couchbase à l'aide du pilote JDBC.

Créer la structure de répertoire
--------------------------------

Nous allons donc commencer par créer une structure de dossiers dans laquelle nous rangerons les éléments de ce tutoriel. Nous donnerons ensuite
les droits d'utilisation de ce dossier aux utilisateurs pour qu'ils puissent utiliser la source de données, mais on ne leur donnera pas la
permission de voir son existence, il s'agit d'un dossier contenant des éléments techniques dont les utilisateurs métiers n'ont pas besoin
d'avoir connaissance, cela polluerait leur référentiel. De même, pour que les éléments de ce tutoriel soient accessibles à tous les utilisateurs
de toutes les organisations (en mode multi-tenancy), nous allons le créer dans la zone publique :
/Public/WorldDevelopment/Resources/DataSources.

Il faut commencer par se connecter à JRS en tant que *jasperadmin* avec le mot de passe par défaut *jasperadmin* (Les bonnes pratiques veulent
que l'on ne se connecte **jamais** avec le compte *superuser*, celui-ci ne doit servir qu'à administrer l'instance de JRS). 
Une fois connecté,
il va falloir définir une source de données. 

Il faut commencer par aller dans le référentiel en ouvrant le menu *Afficher*, puis en sélectionnant *Référentiel* :

TODO:Screenshot Menu Afficher/Référentiel

Il faut créer les répertoires un par un en faisant un clic droit sur le répertoire parent de manière à obtenir la structure suivante :

Nous allons utiliser le sous-répertoire *Resources* pour ranger tous les éléments techniques auxquels les utilisateurs auront besoin d'accéder
sans pour autant en connaître l'existence. Pour cela, nous allons changer les permissions sur le dossier *Resources*. Il faut faire un clic
droit sur le dossier Resources et choisir *Autorisations* :

TODO: Screenshot menu contextuel/Autorisations

Donnons la permission *Exécuter seulement* au rôle *ROLE_USER* et refermons la boîte de dialogue :

TODO: Screenshot Autorisation

Créer la source de données JDBC
-------------------------------

Nous pouvons maintenant créer la source de données JDBC utilisant le pilote Couchbase pour permettre à JRS de se connecter à Couchbase et
d'exécuter des **requêtes SQL sur cette base NOSQL**.

Aller dans le répertoire /Public/WorldDevelopment/Resources/DataSources, faire un clic droit et choisir *Nouveau/Source de données* :

TODO: Screenshot menu contextuel

Sélectionner *Source de données JDBC*, puis choisir *Autre*. Comme le pilote est inconnu de JRS, il faut renseigner les différents champs
suivants :
```
Pilote : 
Chaîne de connexion :
Utilisateur :
Mot de passe :
```

et valider les informations en cliquant sur le bouton *Test* avant d'enregistrer :

TODO: Screenshot

Voila
=====

Vous disposer désormais d'une connexion JDBC vers votre cluster Couchbase. Vous pouvez l'utiliser pour exécuter des requêtes N1QL (SQL) sur le
cluster Couchbase. Il faut évidemment que vous disposiez d'un *bucket* avec des documents, ainsi que des index primaires et secondaires.






[cb40beta]: http://www.couchbase.com/preview/couchbase-server-4-0
[Couchbase]: http://www.couchbase.com
[jrs]: http://community.jaspersoft.com/project/jasperreports-server
