---
layout: page
author: fcerbell
title: Connexion JDBC depuis JasperReports Server à Couchbase
categories: [Tutoriel, Tutorial]
date:   2015-08-26 19:15:06
tags: [couchbase, jaspersoft, reporting, jdbc, n1ql]
featimg: cb.svg
---

[Couchbase], une base BigData NoSQL, propose désormais un nouveau langage, N1QL, pour effectuer des requêtes. L'idée de cet article est de montrer comment utiliser le nouveau pilote JDBC de [Couchbase] dans [JasperReports Server][jrs], de manière à exécuter des requêtes SQL sur la base [Couchbase].

Pré-requis
==========
Comme pour tout tutoriel, il y a des pré-requis nécessaires. Voici ceux concernant celui-ci.

Couchbase Server
----------------
En premier lieu, il faut bien évidemment disposer d'un cluster [Couchbase] au minimum en version 4.0. À l'heure où j'écris ces lignes, il est disponible en [version beta][cb40beta] sur le site de [Couchbase]. Ce cluster doit comporter au moins un nœud avec le service *Index* et au moins un nœud avec le service *Query*.


JasperReports Server
--------------------
En second, il faut disposer d'un serveur [JasperReports][jrs] fonctionnel. Le plus simple est de télécharger la version d'évaluation. Elle comporte toutes les fonctionnalités commerciales et permet de tester l'outil pendant un mois à partir de l'installation. Cette version d'évaluation présente
l'avantage d'embarquer un serveur d'application (Tomcat) et un serveur de base de données (PostgreSQL). Ainsi, en acceptant les choix par défaut, l'application sera installée avec tous ses pré-requis.

Pilote JDBC Couchbase
---------------------
Enfin, il faut disposer du pilote JDBC fourni par [Couchbase]. Il n'est pas encore disponible publiquement pour l'instant, mais il est possible de le demander à Couchbase.

Ajouter le pilote JDBC dans le classpath
========================================

Par défaut, JRS(JasperReports Server) ne fournit pas le pilote JDBC pour Couchbase. Il faut donc ajouter le pilote dans le classpath de la JVM exécutant JRS. Ayant installé JRS avec l'installeur d'évaluation, Apache Tomcat a été installé et configuré pour exécuter JRS. Il se trouve dans le sous-répertoire *apache-tomcat* du répertoire d'installation. L'application JasperReports Server se trouve dans le sous-répertoire *apache-tomcat/webapps/jasperserver-pro*. Il est donc possible d'ajouter le pilote au niveau du serveur de conteneur JAVA (Tomcat), dans le sous-répertoire *apache-tomcat/lib* ou au niveau de l'application dans le sous-répertoire *apache-tomcat/webapps/jasperserver-pro/WEB-INF/lib*. J'ai fait le choix de l'installer au niveau du serveur de conteneur.

Il faut donc copier tous les fichiers du pilote JDBC (sauf éventuellement le fichier PDF), dans le sous-répertoire des bibliothèques partagées de Tomcat :
```cp SimbaCouchbaseJDBC41_Beta_Update3/*.{jar,lic} /opt/jasperreports-server-6.1.0/apache-tomcat/lib/```

Une fois le pilote installé, il faut redémarrer Tomcat. Bien qu'il soit possible de redémarrer uniquement Tomcat, nous allons utiliser le script global qui va redémarrer à la fois Tomcat et PostgreSQL dans le cas d'une installation d'évaluation :
```
cd jasperreports-server-6.1.0
./ctlscript.sh restart
```

Le pilote est désormais disponible dans JRS.

Créer la structure de répertoires
=================================

Nous allons commencer par créer une structure de répertoires pour ranger les différents éléments du tutoriel proprement en suivant les bonnes pratiques. Nous créerons ensuite une source de données se connectant à Couchbase à l'aide du pilote JDBC.

Il faut commencer par se connecter à JRS en tant que *jasperadmin* avec le mot de passe par défaut *jasperadmin* (Les bonnes pratiques veulent que l'on ne se connecte **jamais** avec le compte *superuser*, celui-ci ne doit servir qu'à administrer l'instance de JRS). *jasperadmin* est un compte disposant du rôle d'administration. Il est automatiquement créé lors de la création d'une organisation. Dans notre cas, avec une installation d'évaluation, il existe et nous allons l'utiliser pour ajouter la source de données et la rendre disponible aux autres utilisateurs. Par défaut, *jasperadmin* peut lire et écrire partout (ou presque) alors que *joeuser* (l'utilisateur par défaut créé à l'installation) ne peut écrire que dans un seul répertoire.

Lorsqu'un utilisateur se connecte à JasperReports Server, il accède au référentiel de son organisation. Le référentiel est similaire à un répertoire partagé, avec des sous-répertoires et des objets. Il est possible de donner ou non des permissions sur les répertoires et les objets à des utilisateurs individuellement ou à des rôles (groupes).

Il faut commencer par aller dans le référentiel en ouvrant le menu *Afficher*, puis en sélectionnant *Référentiel* :

![Menu Afficher/Référentiel]({{ site.url }}/assets/JRS/JRS_fr-01.png)

Une instance de JasperReports Server peut être disponible en mode SaaS. Cela signifie qu'elle peut accepter les connections de *Jean Dupont* de la société *JoliesFleurs* et celles de *Jean Dupont* de la société *Fleurs pour tous*, chacun ne pourra accéder qu'aux données de sa société, à travers de modèles de rapports propres à sa société ou partagés, le tout dans une interface aux couleurs de sa société. Il y a donc des emplacements privés par organisation et d'autres communs. Dans le cadre de notre tutoriel, nous allons placer les éléments de connexion dans la zone commune pour que toutes les organisations puissent utiliser cette connexion. Ce sera donc un répertoire projet dans le répertoire commun : */Public/WorldDevelopment* :

![Menu Nouveau/Dossier]({{ site.url }}/assets/JRS_fr-02.png)
![Création du dossier du projet]({{ site.url }}/assets/JRS/JRS_fr-03.png)

Parmi les éléments que nous allons créer, il y a des éléments techniques (les sources de données, les requêtes, les logos, les invites, ...) et les éléments métier (modèles de rapports, rapports, affichages à la demande, tableaux de bord, ...). Les éléments métier dépendent des éléments techniques pour pouvoir fonctionner. En revanche, autant l'utilisateur métier final souhaite voir les éléments métiers, autant il n'est pas intéressé par leurs dépendances techniques. Il est donc utile de les rendre utilisables par l'utilisateur final, sans lui laisser les voir pour ne pas polluer son interface. Nous allons donc créer un sous-répertoire technique dans lequel nous rangerons tous les éléments pour lesquels l'utilisateur final doit avoir les permissions d'utilisation, sans les permissions de listage : */Public/WorldDevelopment/Resources*.

![Création du dossier des ressources techniques]({{ site.url }}/assets/JRS/JRS_fr-04.png)

Nous allons continuer à suivre les bonnes pratiques. Il n'est pas question de mettre en vrac tous les objets techniques, nous allons donc les ranger dans des sous-répertoires techniques. Dans ce tutoriel, nous voyons comment créer une source de données, nous allons donc ranger cette source de données avec toutes les autres sources de données du projet *WorldDevelopment* dans un sous-répertoire : */Public/WorldDevelopment/Resources/DataSources*.

![Création du dossier des sources de données]({{ site.url }}/assets/JRS/JRS_fr-05.png)

Nous allons donc utiliser le sous-répertoire *Resources* pour ranger tous les éléments techniques pour lesquels les utilisateurs auront les permissions d'utilisation sans pour autant avoir les permissions d'affichage. Pour cela, nous allons changer les permissions sur le dossier *Resources*. Il faut faire un clic droit sur le dossier Resources et choisir *Autorisations* :

![Menu contextuel des autorisations]({{ site.url }}/assets/JRS/JRS_fr-06.png)

Donnons la permission *Exécuter seulement* au rôle *ROLE_USER* et refermons la boîte de dialogue :

![Permissions sur les ressources techniques]({{ site.url }}/assets/JRS/JRS_fr-07.png)

Nous disposons maintenant d'une structure de répertoires commune à toutes les organisations (il n'y en a qu'une seule par défaut à l'installation) et dont les éléments techniques seront cachés aux utilisateurs métiers.

Créer la source de données JDBC
===============================

Nous pouvons maintenant créer la source de données JDBC utilisant le pilote Couchbase pour permettre à JRS de se connecter à Couchbase et d'exécuter des **requêtes SQL sur cette base NOSQL**.

Aller dans le répertoire */Public/WorldDevelopment/Resources/DataSources*, faire un clic droit et choisir *Nouveau/Source de données* :

TODO: Screenshot menu contextuel

Sélectionner *Source de données JDBC*, puis choisir *Autre*. Comme le pilote est inconnu de JRS, il faut renseigner les différents champs suivants :
```
Pilote :
Chaîne de connexion :
Utilisateur :
Mot de passe :
```

et valider les informations en cliquant sur le bouton *Test* avant d'enregistrer :

TODO: Screenshot Datasource definition with green Test

Voila
=====

Vous disposez désormais d'une connexion JDBC vers votre cluster Couchbase. Vous pouvez l'utiliser pour exécuter des requêtes N1QL (SQL) sur le cluster Couchbase. Il faut évidemment que vous disposiez d'un *bucket* avec des documents, ainsi que des index primaires et secondaires.


[cb40beta]: http://www.couchbase.com/preview/couchbase-server-4-0
[Couchbase]: http://www.couchbase.com
[jrs]: http://community.jaspersoft.com/project/jasperreports-server
